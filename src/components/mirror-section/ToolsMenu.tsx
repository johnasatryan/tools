import React, { useEffect, useState, useRef } from 'react';
import ImageMirror from './ImageMirror';
import { toolsTypes } from '../../types/toolsTypes';
import SharePopUp from '../popUps/share-popup';
// #### Redux
import { useSelector } from 'react-redux';

export default function ToolsMenu({ data, onFlip, imgRef }: toolsTypes) {
  const image = useSelector((state: any) => state.image);
  const [sharePopUp, setSharePopUp] = useState<boolean>(false);
  const [enable, setEnable] = useState(true);
  useEffect(() => {
    if (!image) {
      setEnable(true);
    } else {
      setTimeout(() => {
        setEnable(false);
      }, 3000);
    }
  }, [image]);

  const SharePopup = (e: any) => {
    e.preventDefault();
    setSharePopUp(!sharePopUp);
  };

  const downloadHandler = () => {
    fetch(data.imgPath ? data.imgPath : image, {
      method: 'GET',
      headers: {},
    })
      .then((response) => {
        response.arrayBuffer().then(function (buffer) {
          const ext = image?.split(';')[0].split('/')[1];
          const url = window.URL.createObjectURL(new Blob([buffer]));
          const link = document.createElement('a');
          link.href = url;
          link.setAttribute('download', `image.${ext}`);
          document.body.appendChild(link);
          link.click();
        });
      })
      .catch((err) => {
        console.log(err);
      });
  };

  return (
    <div className='toolsmenu'>
      <header className='u-margin-bottom-xm'>
        <h2 className='heading-secondary u-line-height-40 '>Format settings</h2>
      </header>
      <main className='toolsmenu-top'>
        <div className='tools'>
          <p className='tools-title'>Flip direction</p>
          <ImageMirror
            data={data}
            onFlip={onFlip}
            imgRef={imgRef}
            btState={enable}
          />
        </div>
      </main>
      <div className='toolsmenu-buttons-box'>
        <button
          className={`btn btn-share u-margin-right-s ${
            enable ? 'btndisable' : ''
          }`}
          onClick={SharePopup}
          disabled={enable}
        >
          <svg
            width='24'
            height='24'
            viewBox='0 0 21 22'
            fill='none'
            xmlns='http://www.w3.org/2000/svg'
          >
            <path d='M16.6719 0.992188C15.625 0.992188 14.7344 1.35937 14 2.09375C13.2812 2.82813 12.9219 3.71094 12.9219 4.74219C12.9219 4.89844 12.9297 5.04688 12.9453 5.1875C12.9609 5.32812 12.9844 5.46875 13.0156 5.60938L7.15625 8.75C6.8125 8.29688 6.38281 7.9375 5.86719 7.67188C5.35156 7.39062 4.78125 7.25 4.15625 7.25C3.125 7.25 2.24219 7.61719 1.50781 8.35156C0.773438 9.08594 0.40625 9.96875 0.40625 11C0.40625 12.0312 0.773438 12.9141 1.50781 13.6484C2.24219 14.3828 3.125 14.75 4.15625 14.75C4.76562 14.75 5.32812 14.6172 5.84375 14.3516C6.375 14.0703 6.8125 13.7031 7.15625 13.25L12.9922 16.4844C12.9609 16.6094 12.9375 16.7344 12.9219 16.8594C12.9219 16.9844 12.9219 17.1172 12.9219 17.2578C12.9219 18.2891 13.2812 19.1719 14 19.9062C14.7344 20.6406 15.625 21.0078 16.6719 21.0078C17.7031 21.0078 18.5859 20.6406 19.3203 19.9062C20.0547 19.1719 20.4219 18.2891 20.4219 17.2578C20.4219 16.2109 20.0547 15.3281 19.3203 14.6094C18.5859 13.875 17.7031 13.5078 16.6719 13.5078C16.0469 13.5078 15.4688 13.6484 14.9375 13.9297C14.4062 14.2109 13.9688 14.5859 13.625 15.0547L7.8125 11.8438C7.84375 11.7188 7.86719 11.5859 7.88281 11.4453C7.89844 11.2891 7.90625 11.1406 7.90625 11C7.90625 10.8594 7.89844 10.7188 7.88281 10.5781C7.86719 10.4375 7.84375 10.2969 7.8125 10.1562L13.6719 7.01562C14.0156 7.46875 14.4453 7.82812 14.9609 8.09375C15.4922 8.35938 16.0625 8.49219 16.6719 8.49219C17.7031 8.49219 18.5859 8.13281 19.3203 7.41406C20.0547 6.67969 20.4219 5.78906 20.4219 4.74219C20.4219 3.71094 20.0547 2.82813 19.3203 2.09375C18.5859 1.35937 17.7031 0.992188 16.6719 0.992188ZM14.4219 4.74219C14.4219 4.13281 14.6406 3.60937 15.0781 3.17188C15.5156 2.71875 16.0469 2.49219 16.6719 2.49219C17.2812 2.49219 17.8047 2.71875 18.2422 3.17188C18.6953 3.60937 18.9219 4.13281 18.9219 4.74219C18.9219 5.36719 18.6953 5.89844 18.2422 6.33594C17.8047 6.77344 17.2812 6.99219 16.6719 6.99219C16.0469 6.99219 15.5156 6.77344 15.0781 6.33594C14.6406 5.89844 14.4219 5.36719 14.4219 4.74219ZM1.90625 11C1.90625 10.375 2.125 9.84375 2.5625 9.40625C3.01562 8.96875 3.54688 8.75 4.15625 8.75C4.78125 8.75 5.3125 8.96875 5.75 9.40625C6.1875 9.84375 6.40625 10.375 6.40625 11C6.40625 11.625 6.1875 12.1562 5.75 12.5938C5.3125 13.0312 4.78125 13.25 4.15625 13.25C3.54688 13.25 3.01562 13.0312 2.5625 12.5938C2.125 12.1562 1.90625 11.625 1.90625 11ZM16.6719 15.0078C17.2812 15.0078 17.8047 15.2266 18.2422 15.6641C18.6953 16.1016 18.9219 16.6328 18.9219 17.2578C18.9219 17.8672 18.6953 18.3984 18.2422 18.8516C17.8047 19.2891 17.2812 19.5078 16.6719 19.5078C16.0469 19.5078 15.5156 19.2891 15.0781 18.8516C14.6406 18.3984 14.4219 17.8672 14.4219 17.2578C14.4219 16.6328 14.6406 16.1016 15.0781 15.6641C15.5156 15.2266 16.0469 15.0078 16.6719 15.0078Z' />
          </svg>

          <span className='btn-text-primary btn-text-primary--purple'>
            Share image
          </span>
        </button>
        <button
          className={`btn btn-download ${enable ? 'btndisable' : ''}`}
          onClick={downloadHandler}
          disabled={enable}
        >
          <svg
            width='24'
            height='24'
            viewBox='0 0 21 22'
            fill='none'
            xmlns='http://www.w3.org/2000/svg'
          >
            <path
              d='M10.1641 1.74219C10.1641 1.53906 10.2344 1.36719 10.375 1.22656C10.5312 1.07031 10.7109 0.992188 10.9141 0.992188C11.1172 0.992188 11.2891 1.07031 11.4297 1.22656C11.5859 1.36719 11.6641 1.53906 11.6641 1.74219V13.2266L13.9141 10.9766C14.0703 10.8203 14.25 10.7422 14.4531 10.7422C14.6562 10.7422 14.8281 10.8203 14.9688 10.9766C15.125 11.1172 15.2031 11.2969 15.2031 11.5156C15.2031 11.7188 15.125 11.8906 14.9688 12.0312L11.4531 15.5703C11.2969 15.7109 11.1172 15.7812 10.9141 15.7812C10.7109 15.7812 10.5312 15.7109 10.375 15.5703L6.85938 12.0312C6.70312 11.8906 6.625 11.7188 6.625 11.5156C6.625 11.2969 6.70312 11.1172 6.85938 10.9766C7 10.8203 7.17188 10.7422 7.375 10.7422C7.57812 10.7422 7.75781 10.8203 7.91406 10.9766L10.1641 13.2266V1.74219ZM2.3125 12.7109C2.3125 12.5078 2.24219 12.3438 2.10156 12.2188C1.96094 12.0781 1.79688 12.0078 1.60938 12.0078C1.42188 12.0078 1.25781 12.0781 1.11719 12.2188C0.976562 12.3438 0.90625 12.5078 0.90625 12.7109V16.5078C0.90625 17.7422 1.33594 18.8047 2.19531 19.6953C3.07031 20.5703 4.11719 21.0078 5.33594 21.0078H16.4922C17.7109 21.0078 18.75 20.5703 19.6094 19.6953C20.4844 18.8047 20.9219 17.7422 20.9219 16.5078V12.7109C20.9219 12.5078 20.8516 12.3438 20.7109 12.2188C20.5703 12.0781 20.4062 12.0078 20.2188 12.0078C20.0312 12.0078 19.8672 12.0781 19.7266 12.2188C19.5859 12.3438 19.5156 12.5078 19.5156 12.7109V16.5078C19.5156 17.3516 19.2188 18.0781 18.625 18.6875C18.0469 19.2812 17.3359 19.5781 16.4922 19.5781H5.33594C4.49219 19.5781 3.77344 19.2812 3.17969 18.6875C2.60156 18.0781 2.3125 17.3516 2.3125 16.5078V12.7109Z'
              fill='white'
            />
          </svg>
          <span className='btn-text-primary btn-text-primary--white'>
            Download
          </span>
        </button>
      </div>
      {sharePopUp && <SharePopUp data={data} setSharePopUp={setSharePopUp} />}
    </div>
  );
}
